name: NEAR Sandbox Test

on: [push, pull_request]

jobs:
  sandbox-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run sandbox integration tests
        env:
          NEAR_NO_LOGS: 1
        run: |
          echo "Starting sandbox integration tests..."

          # Start the API service in background
          npm run start:sandbox &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID"

          # Wait for server to start AND NEAR to initialize
          for i in {1..60}; do
            if curl -s http://localhost:3000/ > /dev/null; then
              echo "âœ… API server is responding"

              # Check if NEAR is initialized by testing the API
              TEST_RESPONSE=$(curl -s -X POST http://localhost:3000/send-ft \
                -H "Content-Type: application/json" \
                -d '{"receiverId": "test.near", "amount": "1000"}' 2>/dev/null || echo "connection_error")

              if echo "$TEST_RESPONSE" | grep -q '"error"' && echo "$TEST_RESPONSE" | grep -q "NEAR connection not initialized"; then
                echo "â³ NEAR connection not ready yet... ($i/60)"
                sleep 2
                continue
              else
                echo "âœ… NEAR connection is ready!"
                break
              fi
            else
              echo "â³ Waiting for server... ($i/60)"
              sleep 2
            fi
          done

          if [ $i -eq 60 ]; then
            echo "âŒ Server or NEAR initialization failed to complete within 2 minutes"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          # Test API endpoints with proper data
          echo "ðŸ§ª Testing API endpoints..."

          # Test health check
          if ! curl -f http://localhost:3000/; then
            echo "âŒ Health check failed"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          # Test FT transfer (this will use near-workspaces internally)
          RESPONSE=$(curl -s -X POST http://localhost:3000/send-ft \
            -H "Content-Type: application/json" \
            -d '{"receiverId": "user.test.near", "amount": "1000000000000000000", "memo": "CI test"}')

          echo "ðŸ“„ API Response: $RESPONSE"

          # Check if transfer was successful
          if echo "$RESPONSE" | grep -q '"error"'; then
            echo "âŒ API test failed - sandbox integration issue"
            echo "Response: $RESPONSE"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          else
            echo "âœ… API test passed - sandbox working correctly"
          fi

          # Run Artillery benchmark
          echo "ðŸŽ¯ Running Artillery benchmark..."
          npx artillery run benchmark.yml --environment sandbox --output benchmark-sandbox-ci.json

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: sandbox-benchmark-results
          path: |
            benchmark-sandbox-ci.json
            artillery_report_*.html