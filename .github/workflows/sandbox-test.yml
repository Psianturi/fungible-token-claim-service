# .github/workflows/sandbox-test.yml
name: Sandbox Integration (CI)

on:
  push:
  pull_request:

jobs:
  sandbox-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci --silent

      - name: Try to install neard binary from nearcore releases
        id: install_neard
        run: |
          set -euo pipefail
          VERSION="1.39.0"
          TRIES=( "neard-${VERSION}-x86_64-unknown-linux-gnu.tar.gz" "neard-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" )
          OK=0
          for name in "${TRIES[@]}"; do
            URL="https://github.com/near/nearcore/releases/download/${VERSION}/${name}"
            echo "Trying $URL ..."
            if curl -sSL --fail -o /tmp/neard.tar.gz "$URL"; then
              mkdir -p /tmp/neard_unpack
              tar -xzf /tmp/neard.tar.gz -C /tmp/neard_unpack
              if [ -f /tmp/neard_unpack/neard ]; then
                sudo mv /tmp/neard_unpack/neard /usr/local/bin/neard
                OK=1
                break
              fi
              # try nested location
              found=$(find /tmp/neard_unpack -type f -name neard | head -n1 || true)
              if [ -n "$found" ]; then
                sudo mv "$found" /usr/local/bin/neard
                OK=1
                break
              fi
            fi
          done
          if [ "$OK" -eq 1 ]; then
            sudo chmod +x /usr/local/bin/neard
            echo "neard installed"
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "neard not installed"
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Start neard sandbox (if installed)
        if: steps.install_neard.outputs.installed == 'true'
        run: |
          set -euo pipefail
          export NEAR_HOME="$HOME/.near"
          mkdir -p "$NEAR_HOME"
          # init if needed (non-fatal)
          neard --home "$NEAR_HOME" init --chain-id sandbox || true
          nohup neard --home "$NEAR_HOME" run > neard.log 2>&1 &
          # wait for jsonrpc
          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3030/status >/dev/null 2>&1; then
              echo "sandbox ready"
              break
            fi
            sleep 1
          done
          curl -sS http://127.0.0.1:3030/status || (echo "neard didn't start" && cat neard.log && exit 1)

      - name: Wait for NEAR Sandbox to be ready
        if: steps.install_neard.outputs.installed == 'true'
        run: |
          set -euo pipefail
          echo "‚è≥ Waiting for NEAR Sandbox to be fully ready..."

          # Wait for sandbox RPC to respond
          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3030/status >/dev/null 2>&1; then
              echo "‚úÖ Sandbox RPC is responding"
              break
            fi
            echo "‚è≥ Waiting for sandbox RPC... ($i/60)"
            sleep 2
          done

          if [ $i -eq 60 ]; then
            echo "‚ùå Sandbox RPC did not respond within 2 minutes"
            exit 1
          fi

      - name: Start NEAR sandbox via near-sandbox (npm fallback)
        if: steps.install_neard.outputs.installed == 'false'
        run: |
          set -euo pipefail
          echo "Starting near-sandbox fallback (init + run)..."
          npx near-sandbox init || true
          nohup npx near-sandbox run > neard.log 2>&1 &
          # wait for jsonrpc
          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3030/status >/dev/null 2>&1; then
              echo "‚úÖ near-sandbox fallback ready"
              break
            fi
            sleep 1
          done
          curl -sS http://127.0.0.1:3030/status || (echo "near-sandbox fallback didn't start" && cat neard.log && exit 1)
      - name: Deploy FT contract to sandbox via RPC (near-api-js)
        if: steps.install_neard.outputs.installed == 'true'
        env:
          NODE_URL: http://127.0.0.1:3030
          MASTER_ACCOUNT: test.near
          FT_CONTRACT: ft.test.near
          RECEIVER_ID: user.test.near
          MASTER_ACCOUNT_PRIVATE_KEY: ed25519:5c28XPtgXLrqfS22C8R8ynBiYvjjfu4BnH21wRrtvQeZyz4XiS3M7Fom867VcgPrfbxh3ui1SPXZ14Uz1chmeoi6
        run: |
          set -euo pipefail
          echo "üöÄ Deploying FT contract to sandbox RPC..."
          echo "PWD: $(pwd)"
          echo "Workspace listing:"
          ls -la
          echo "ci/ listing:"
          ls -la ci
          echo "HOME: ${HOME}"
          echo "Listing ${HOME}/.near (if exists):"
          ls -la "${HOME}/.near" || true
          echo "Attempt to print validator_key.json locations (if any):"
          for p in "${HOME}/.near/validator_key.json" "${HOME}/.near/data/validator_key.json" "${HOME}/.near/node/validator_key.json" "${HOME}/.near/node0/validator_key.json" "${HOME}/.near/sandbox/validator_key.json"; do
            if [ -f "$p" ]; then
              echo "Found: $p"
              head -n 5 "$p" || true
            fi
          done

          echo "üîé Checking sandbox RPC status before deploy..."
          READY=0
          for i in $(seq 1 30); do
            if curl -sS http://127.0.0.1:3030/status >/dev/null 2>&1; then
              READY=1
              break
            fi
            sleep 1
          done

          if [ "$READY" -ne 1 ]; then
            echo "‚ö†Ô∏è Sandbox RPC not responding, attempting near-sandbox fallback start (init + run)..."
            npx near-sandbox init || true
            nohup npx near-sandbox run > neard.log 2>&1 &
            for i in $(seq 1 60); do
              if curl -sS http://127.0.0.1:3030/status >/dev/null 2>&1; then
                READY=1
                break
              fi
              sleep 1
            done
          fi

          if [ "$READY" -ne 1 ]; then
            echo "‚ùå Sandbox RPC still not responding, showing neard.log (if any) and failing"
            [ -f neard.log ] && tail -n +1 neard.log || echo "neard.log not found"
            exit 1
          fi

          node ci/deploy-sandbox-rpc.mjs
          echo "‚úÖ Contract deployment completed"

      - name: Deploy FT contract to sandbox via RPC (near-sandbox fallback)
        if: steps.install_neard.outputs.installed == 'false'
        env:
          NODE_URL: http://127.0.0.1:3030
          MASTER_ACCOUNT: test.near
          FT_CONTRACT: ft.test.near
          RECEIVER_ID: user.test.near
          MASTER_ACCOUNT_PRIVATE_KEY: ed25519:5c28XPtgXLrqfS22C8R8ynBiYvjjfu4BnH21wRrtvQeZyz4XiS3M7Fom867VcgPrfbxh3ui1SPXZ14Uz1chmeoi6
        run: |
          set -euo pipefail
          echo "üöÄ Deploying FT contract to sandbox RPC (fallback)..."
          echo "PWD: $(pwd)"
          echo "Workspace listing:"
          ls -la
          echo "ci/ listing:"
          ls -la ci
          echo "HOME: ${HOME}"
          echo "Listing ${HOME}/.near (if exists):"
          ls -la "${HOME}/.near" || true
          node ci/deploy-sandbox-rpc.mjs
          echo "‚úÖ Contract deployment (fallback) completed"

      - name: Fallback to run tests against testnet (if no sandbox)
        if: steps.install_neard.outputs.installed == 'false'
        run: |
          echo "neard not available in runner. We'll run integration steps against testnet as fallback."
          echo "NEAR_ENV=testnet" >> $GITHUB_ENV
          echo "FT_CONTRACT=posm.testnet" >> $GITHUB_ENV
          echo "MASTER_ACCOUNT=posm.testnet" >> $GITHUB_ENV

      - name: Run server (in background) and tests (sandbox)
        if: steps.install_neard.outputs.installed == 'true'
        env:
          NEAR_ENV: sandbox
          NODE_URL: http://127.0.0.1:3030
          FT_CONTRACT: ft.test.near
          MASTER_ACCOUNT: test.near
          MASTER_ACCOUNT_PRIVATE_KEY: ed25519:5c28XPtgXLrqfS22C8R8ynBiYvjjfu4BnH21wRrtvQeZyz4XiS3M7Fom867VcgPrfbxh3ui1SPXZ14Uz1chmeoi6
        run: |
          npm run start:sandbox &> service.log &
          sleep 3

          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3000/health >/dev/null 2>&1; then
              echo "‚úÖ service up and responding"
              break
            fi
            echo "‚è≥ Waiting for service... ($i/60)"
            sleep 1
          done

          if [ $i -eq 60 ]; then
            echo "‚ùå Service did not start within 1 minute"
            cat service.log
            exit 1
          fi

          echo "üß™ Running integration tests..."
          RECEIVER_ID="user.test.near"

          for attempt in {1..3}; do
            echo "Test attempt $attempt/3"
            RESPONSE=$(curl -s -X POST http://127.0.0.1:3000/send-ft \
              -H "Content-Type: application/json" \
              -d "{\"receiverId\": \"${RECEIVER_ID}\", \"amount\": \"1000000\", \"memo\": \"CI test\"}" || echo "connection_error")
            echo "API Response: $RESPONSE"
            if echo "$RESPONSE" | grep -q '"message"' && echo "$RESPONSE" | grep -q "FT transfer"; then
              echo "‚úÖ FT transfer test passed!"
              break
            else
              echo "‚ùå FT transfer test failed (attempt $attempt)"
              if [ $attempt -eq 3 ]; then
                echo "Final response: $RESPONSE"
                exit 1
              fi
              sleep 5
            fi
          done

          echo "üéØ Running Artillery benchmark..."
          npx artillery run benchmark.yml --output benchmark-sandbox.json || true

      - name: Run server (in background) and tests (fallback)
        if: steps.install_neard.outputs.installed == 'false'
        env:
          NEAR_ENV: sandbox
          NODE_URL: http://127.0.0.1:3030
          FT_CONTRACT: ft.test.near
          MASTER_ACCOUNT: test.near
          MASTER_ACCOUNT_PRIVATE_KEY: ed25519:5c28XPtgXLrqfS22C8R8ynBiYvjjfu4BnH21wRrtvQeZyz4XiS3M7Fom867VcgPrfbxh3ui1SPXZ14Uz1chmeoi6
        run: |
          npm run start:sandbox &> service.log &
          sleep 3

          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3000/health >/dev/null 2>&1; then
              echo "‚úÖ service up and responding"
              break
            fi
            echo "‚è≥ Waiting for service... ($i/60)"
            sleep 1
          done

          if [ $i -eq 60 ]; then
            echo "‚ùå Service did not start within 1 minute"
            cat service.log
            exit 1
          fi

          echo "üß™ Running integration tests..."
          RECEIVER_ID="user.test.near"

          for attempt in {1..3}; do
            echo "Test attempt $attempt/3"
            RESPONSE=$(curl -s -X POST http://127.0.0.1:3000/send-ft \
              -H "Content-Type: application/json" \
              -d "{\"receiverId\": \"${RECEIVER_ID}\", \"amount\": \"1000000\", \"memo\": \"CI test\"}" || echo "connection_error")
            echo "API Response: $RESPONSE"
            if echo "$RESPONSE" | grep -q '"message"' && echo "$RESPONSE" | grep -q "FT transfer"; then
              echo "‚úÖ FT transfer test passed!"
              break
            else
              echo "‚ùå FT transfer test failed (attempt $attempt)"
              if [ $attempt -eq 3 ]; then
                echo "Final response: $RESPONSE"
                exit 1
              fi
              sleep 5
            fi
          done

          echo "üéØ Running Artillery benchmark..."
          npx artillery run benchmark.yml --output benchmark-sandbox.json || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: sandbox-logs
          path: |
            neard.log
            service.log
            benchmark-sandbox.json