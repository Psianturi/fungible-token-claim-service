name: Sandbox Integration (CI)

on:
  push:
  pull_request:

jobs:
  sandbox-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install deps (ci or install fallback)
        run: |
          if [ -f package-lock.json ]; then npm ci --silent; else npm install --silent; fi

      - name: Try to install neard binary from nearcore releases
        id: install_neard
        run: |
          set -euo pipefail
          VERSION="2.6.5"   # sesuaikan versi yang kamu pakai
          TRIES=( "neard-${VERSION}-x86_64-unknown-linux-gnu.tar.gz" "neard-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" )
          OK=0
          for name in "${TRIES[@]}"; do
            URL="https://github.com/near/nearcore/releases/download/${VERSION}/${name}"
            echo "Trying $URL ..."
            if curl -sSL --fail -o /tmp/neard.tar.gz "$URL"; then
              mkdir -p /tmp/neard_unpack
              tar -xzf /tmp/neard.tar.gz -C /tmp/neard_unpack
              if [ -f /tmp/neard_unpack/neard ]; then
                sudo mv /tmp/neard_unpack/neard /usr/local/bin/neard
                OK=1
                break
              fi
              # try nested location
              found=$(find /tmp/neard_unpack -type f -name neard | head -n1 || true)
              if [ -n "$found" ]; then
                sudo mv "$found" /usr/local/bin/neard
                OK=1
                break
              fi
            fi
          done
          if [ "$OK" -eq 1 ]; then
            sudo chmod +x /usr/local/bin/neard
            echo "neard installed"
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "neard not installed"
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Start neard sandbox (if installed)
        if: steps.install_neard.outputs.installed == 'true'
        run: |
          set -euo pipefail
          export NEAR_HOME="$HOME/.near"
          mkdir -p "$NEAR_HOME"
          # init if needed (non-fatal)
          neard --home "$NEAR_HOME" init --chain-id sandbox || true
          nohup neard --home "$NEAR_HOME" run > neard.log 2>&1 &
          # wait for jsonrpc
          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3030/status >/dev/null 2>&1; then
              echo "sandbox ready"
              break
            fi
            sleep 1
          done
          curl -sS http://127.0.0.1:3030/status || (echo "neard didn't start" && cat neard.log && exit 1)

      - name: Fallback to run tests against testnet (if no sandbox)
        if: steps.install_neard.outputs.installed == 'false'
        run: |
          echo "neard not available in runner. We'll run integration steps against testnet as fallback."
          # set env so app uses testnet config
          echo "NEAR_ENV=testnet" >> $GITHUB_ENV

      - name: Run server (in background) and tests
        run: |
          # start service (server uses NEAR_ENV from env or .env)
          NEAR_ENV=${NEAR_ENV:-sandbox} npm run start:sandbox &> service.log &
          sleep 2
          # Wait for API to respond (up to 60s)
          for i in $(seq 1 60); do
            if curl -sS http://127.0.0.1:3000/health >/dev/null 2>&1; then
              echo "service up"; break
            fi
            sleep 1
          done
          # run benchmark or integration test
          npx artillery run benchmark.yml --output benchmark-sandbox.json || true
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: sandbox-logs
          path: |
            neard.log
            service.log
            benchmark-sandbox.json